name: CI (API smoke)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  api-smoke:
    name: API smoke test (src/api.py)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install uvicorn fastapi flask requests
          fi

      - name: Detect framework
        id: detect
        run: |
          if grep -q "FastAPI" src/api.py 2>/dev/null; then
            echo "framework=fastapi" >> $GITHUB_OUTPUT
          elif grep -q "Flask" src/api.py 2>/dev/null || grep -q "flask" src/api.py 2>/dev/null; then
            echo "framework=flask" >> $GITHUB_OUTPUT
          else
            echo "framework=script" >> $GITHUB_OUTPUT
          fi
          echo "port=8000" >> $GITHUB_OUTPUT

      - name: Start API and wait for readiness
        env:
          FRAMEWORK: ${{ steps.detect.outputs.framework }}
          PORT: ${{ steps.detect.outputs.port }}
        run: |
          set -euo pipefail
          mkdir -p ci_run
          if [ "$FRAMEWORK" = "fastapi" ]; then
            CMD="uvicorn src.api:app --host 127.0.0.1 --port $PORT"
          elif [ "$FRAMEWORK" = "flask" ]; then
            export FLASK_APP=src.api
            CMD="flask run --host=127.0.0.1 --port $PORT"
          else
            CMD="python src/api.py"
          fi
          echo "Starting: $CMD"
          nohup bash -c "$CMD" > ci_run/api.log 2>&1 & echo $! > ci_run/api.pid
          for i in $(seq 1 60); do
            if curl -sS --max-time 2 "http://127.0.0.1:$PORT/" >/dev/null 2>&1; then
              echo "Server ready"
              break
            fi
            sleep 1
            if [ $i -eq 60 ]; then
              echo "Server did not start within 60s"
              tail -n +1 ci_run/api.log || true
              exit 1
            fi
          done
          curl -sS "http://127.0.0.1:$PORT/" -o ci_run/smoke_response.txt || true

      - name: Run smoke request with requests
        env:
          PORT: ${{ steps.detect.outputs.port }}
        run: |
          python - <<'PY'
          import os, sys, requests
          port = int(os.environ.get("PORT", "8000"))
          try:
            r = requests.get(f"http://127.0.0.1:{port}/", timeout=5)
            print("STATUS", r.status_code)
            print("BODY", r.text[:100])
          except Exception as e:
            print("Smoke request failed:", e)
            sys.exit(1)
          PY

      - name: Upload logs and response
        uses: actions/upload-artifact@v4
        with:
          name: api-smoke-artifacts
          path: |
            ci_run/api.log
            ci_run/smoke_response.txt
            ci_run/api.pid